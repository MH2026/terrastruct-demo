<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Terrastruct • Operations Control</title>
<style>
  :root{
    --bg:#0b0d12;--panel:#111620;--panel2:#141a25;--ink:#eaf1ff;--ink-dim:#9db0c8;
    --line:#243249;--accent:#6ee3ff;--ok:#1dd1a1;--warn:#feca57;--bad:#ff6b6b;--radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(120% 120% at 70% 0%,#0e1420 0%,#090c12 45%,#070a0f 100%);color:var(--ink);
       font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1280px;margin:28px auto;padding:0 18px 60px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand .logo{width:36px;height:36px;border-radius:50%;background:
      radial-gradient(120% 120% at 30% 20%, #cfd8e6 0%, #9aa6b8 25%, #5c6776 50%, #2f363f 65%, #0d1117 100%);
      position:relative;box-shadow:0 2px 24px rgba(110,227,255,.15)}
  .brand .logo:before{content:"T";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      font-weight:800;color:#e6eefb;letter-spacing:.5px;text-shadow:0 1px 3px rgba(0,0,0,.5)}
  .brand .title{font-weight:700;letter-spacing:.4px}
  .chip{font-size:12px;color:#c1d2ea;border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#0f1520}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,#151b26,#0f1420);border:1px solid var(--line);
        border-radius:var(--radius);box-shadow:0 12px 30px rgba(0,0,0,.35);overflow:hidden}
  .card-hd{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--line);padding:12px 14px}
  .card-hd h3{margin:0;font-size:15px;letter-spacing:.3px}
  .sub{font-size:12px;color:var(--ink-dim)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid #2b3a52;background:#0f1623;color:var(--ink);padding:9px 12px;border-radius:10px;
       font-weight:600;cursor:pointer}
  .btn:hover{border-color:#3a4c6a;transform:translateY(-1px)}
  .btn.primary{background:linear-gradient(180deg,#0fb6d9,#0aa1c1);border-color:#119db7}
  .kv{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  @media (max-width:980px){.kv{grid-template-columns:repeat(2,1fr)}}
  .kv .tile{background:linear-gradient(180deg,#161d2a,#111826);border:1px solid var(--line);border-radius:12px;padding:12px}
  .kv .k{font-size:12px;color:#9fb2cc}
  .kv .v{font-size:20px;font-weight:700;margin-top:6px}
  .status-dot{width:9px;height:9px;border-radius:50%}
  .ok{background:var(--ok);box-shadow:0 0 12px var(--ok)}
  .bad{background:var(--bad);box-shadow:0 0 12px var(--bad)}
  .warn{background:var(--warn);box-shadow:0 0 12px var(--warn)}
  .section{margin-top:18px}
  .panel-pad{padding:12px 14px}
  .flex{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  .radar{position:relative;aspect-ratio:16/9;background:#0b1118}
  .radar video,.radar img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:contrast(1.05) saturate(1.08)}
  .glass{position:absolute;inset:0;background:radial-gradient(120% 120% at 80% 0%,rgba(110,227,255,.10),transparent 50%),linear-gradient(rgba(4,7,10,.18),rgba(4,7,10,.35))}
  .wm{position:absolute;left:10px;bottom:10px;font-size:11px;color:#93a6c5;background:rgba(8,12,18,.55);
      padding:6px 8px;border-radius:8px;border:1px solid #1c2432}
  .note{font-size:12px;color:#8fa3c2}
  .toolbar{display:flex;gap:10px;align-items:center}
  input,select{background:#0f1623;color:#dfe9fb;border:1px solid #2b3a52;border-radius:10px;padding:8px 10px}
  .chart-wrap{padding:12px 14px}
  canvas{width:100%;height:260px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-top:1px solid #233149;padding:10px 8px}
  th{color:#bcd0ef;text-align:left;font-weight:600}
  tr:hover td{background:#0e1521}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="title">TERRASTRUCT • Admin Control</div>
      <span class="chip">Showka – Hajar Microclimate Ops</span>
    </div>
    <div class="row">
      <span class="chip" id="simClock">--:--</span>
      <span class="chip">DEMO MODE</span>
    </div>
  </header>

  <!-- TOP STATS -->
  <div class="card">
    <div class="card-hd">
      <h3>Site Overview</h3>
      <div class="flex">
        <div class="flex"><div class="status-dot ok"></div><span class="sub">AI Agents: Connected</span></div>
        <div class="flex"><div class="status-dot ok"></div><span class="sub">Fleet Telemetry</span></div>
        <div class="flex"><div class="status-dot warn"></div><span class="sub">Weather: Watch</span></div>
      </div>
    </div>
    <div class="panel-pad">
      <div class="kv" id="kvStats">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <div class="section grid">

    <!-- LEFT COLUMN -->
    <div class="col">

      <!-- OPERATIONS RANGE + SEARCH -->
      <div class="card">
        <div class="card-hd">
          <h3>Operations History</h3>
          <div class="toolbar">
            <label class="sub">From</label><input type="date" id="fromDate">
            <label class="sub">To</label><input type="date" id="toDate">
            <button class="btn" id="btnApply">Apply</button>
            <button class="btn" id="btnLastStorm">Last Storm</button>
          </div>
        </div>
        <div class="chart-wrap">
          <canvas id="opsChart" height="260"></canvas>
        </div>
        <div class="panel-pad">
          <table id="opsTable">
            <thead><tr>
              <th>Date</th><th>Machine</th><th>Hours</th><th>Material moved (m³)</th><th>Fuel (L)</th><th>Notes</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- WEATHER RADAR (DEMO) -->
      <div class="card">
        <div class="card-hd">
          <h3>Weather Radar • UAE NCM (RAIN.ae)</h3>
          <div class="row">
            <button class="btn" onclick="window.open('https://rain.ae','_blank','noopener')">Open RAIN.ae</button>
            <button class="btn primary" onclick="window.open('https://rain.ae/?view=radar','_blank','noopener')">Open Live Radar</button>
          </div>
        </div>
        <div class="radar" role="img" aria-label="Radar preview">
          <!-- DEMO LOOP: replace with your file names; image is fallback -->
          <video id="radarVid" playsinline autoplay muted loop poster="radar-preview.gif">
            <source src="radar-demo.mp4" type="video/mp4">
          </video>
          <img id="radarImg" src="radar-preview.gif" alt="Radar preview (UAE)" style="display:none" />
          <div class="glass"></div>
          <div class="wm">Source: UAE NCM (RAIN.ae) • Demo mode</div>
        </div>
        <div class="panel-pad">
          <div class="note">When NCM grants tiles/API, replace the video/img with your WebGL radar layer.
            UI remains identical, so the transition is seamless.</div>
        </div>
      </div>

    </div>

    <!-- RIGHT COLUMN -->
    <div class="col">

      <!-- AI AGENTS -->
      <div class="card">
        <div class="card-hd"><h3>AI Agents</h3><span class="sub">Autonomy & Orchestration</span></div>
        <div class="panel-pad">
          <table>
            <thead><tr><th>Agent</th><th>Status</th><th>Last Action</th><th>Confidence</th></tr></thead>
            <tbody id="agentsTable"></tbody>
          </table>
        </div>
      </div>

      <!-- WEATHER SNAPSHOT -->
      <div class="card">
        <div class="card-hd"><h3>Weather Snapshot</h3><span class="sub">Site microclimate (Demo)</span></div>
        <div class="panel-pad" id="wxPanel">
          <!-- Populated by JS (POWER-like fields for demo) -->
        </div>
      </div>

      <!-- SYSTEM LOGS -->
      <div class="card">
        <div class="card-hd"><h3>System Log</h3><span class="sub">Last 24h</span></div>
        <div class="panel-pad">
          <table>
            <thead><tr><th>Time</th><th>Event</th></tr></thead>
            <tbody id="logTable"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const DEMO_MODE = true; // set to false when wiring real feeds
const SITE = { name:"Showka", lat:25.148, lon:56.111, tz:"+04:00" };
const MACHINES = ["Excavator-EX01","WheelLoader-WL02","DumpTruck-DT03","JawCrusher-JC01","Dozer-DZ01","Grader-GR01","BatchTruck-CT01"];
const MS_PER_DAY = 86400000;

/* ====== UTIL ====== */
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const fmt = n => n.toLocaleString(undefined,{maximumFractionDigits:0});
const fmt1 = n => n.toLocaleString(undefined,{maximumFractionDigits:1});
function seedRand(str){let h=2166136261>>>0; for(let i=0;i<str.length;i++){h^=str.charCodeAt(i); h=Math.imul(h,16777619)} return ()=>{h+=0x6D2B79F5; let t=Math.imul(h^h>>>15,1|h); t^=t+Math.imul(t^t>>>7,61|t); return ((t^t>>>14)>>>0)/4294967296}}
const rng = seedRand("terrastruct-showka-6mo");

/* ====== CLOCK ====== */
function tickClock(){
  const el = qs("#simClock");
  const now = new Date();
  el.textContent = now.toLocaleString([], {hour:'2-digit', minute:'2-digit'}) + " • " + SITE.name;
}
setInterval(tickClock, 5000); tickClock();

/* ====== HISTORICAL OPS DATA (6 months synthetic) ====== */
function genOpsData(){
  const today = new Date(); const start = new Date(today - 183*MS_PER_DAY);
  const days = [];
  for(let d=0; d<=183; d++){
    const dt = new Date(start.getTime()+d*MS_PER_DAY);
    const dayKey = dt.toISOString().slice(0,10);
    const dayRng = seedRand("ops"+dayKey);
    const entries = [];
    MACHINES.forEach(m=>{
      // Random work pattern with weather influence proxy
      const workProb = 0.55 + 0.25*Math.sin(d/12) + (dayRng()-0.5)*0.2;
      if(dayRng() < workProb){
        const hours = Math.max(0, (6 + dayRng()*6) * (0.7 + 0.6*Math.max(0, Math.sin(d/20))));
        const moved = hours * (30 + dayRng()*70); // m³
        const fuel  = hours * (7 + dayRng()*10);  // liters
        const note  = (dayRng()>0.92) ? "Blasting window" : (dayRng()>0.85 ? "Maintenance window":"");
        entries.push({date:dayKey, machine:m, hours, moved, fuel, note});
      }
    });
    days.push({date:dayKey, entries});
  }
  return days;
}
const OPS = genOpsData();

/* ====== STATS ====== */
function calcStats(range){
  const rows = []; OPS.forEach(d=>{
    if(d.date >= range.from && d.date <= range.to){ rows.push(...d.entries); }
  });
  const hours = rows.reduce((a,b)=>a+b.hours,0);
  const moved = rows.reduce((a,b)=>a+b.moved,0);
  const fuel  = rows.reduce((a,b)=>a+b.fuel,0);
  const active = new Set(rows.map(r=>r.machine)).size;
  const lakePct = Math.min(100, Math.round(moved/250000*100)); // pretend 250k m³ target
  return {hours,moved,fuel,active,lakePct,days:rows.length};
}
function renderKV(range){
  const s = calcStats(range);
  const el = qs("#kvStats");
  el.innerHTML = `
    <div class="tile"><div class="k">Active machines</div><div class="v">${s.active}/${MACHINES.length}</div></div>
    <div class="tile"><div class="k">Ops hours (range)</div><div class="v">${fmt(s.hours)}</div></div>
    <div class="tile"><div class="k">Material moved (m³)</div><div class="v">${fmt(s.moved)}</div></div>
    <div class="tile"><div class="k">Fuel consumed (L)</div><div class="v">${fmt(s.fuel)}</div></div>
  `;
}

/* ====== DATE RANGE UI ====== */
function initDatePickers(){
  const today = new Date(); const sixAgo = new Date(today - 183*MS_PER_DAY);
  const f = qs("#fromDate"), t = qs("#toDate");
  const iso = d=>d.toISOString().slice(0,10);
  f.min = iso(sixAgo); f.max = iso(today); t.min = iso(sixAgo); t.max = iso(today);
  // default: last 30 days
  const last30 = new Date(today - 29*MS_PER_DAY);
  f.value = iso(last30); t.value = iso(today);
}
initDatePickers();

/* ====== TABLE RENDER ====== */
function renderOpsTable(range){
  const body = qs("#opsTable tbody"); body.innerHTML = "";
  const rows = [];
  OPS.forEach(d=>{
    if(d.date >= range.from && d.date <= range.to){ rows.push(...d.entries); }
  });
  rows.sort((a,b)=>a.date<b.date?1:-1);
  const maxRows = 150; // cap for demo
  rows.slice(0,maxRows).forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.date}</td><td>${r.machine}</td><td>${fmt1(r.hours)}</td><td>${fmt(r.moved)}</td><td>${fmt(r.fuel)}</td><td>${r.note||""}</td>`;
    body.appendChild(tr);
  });
}

/* ====== CHART (vanilla canvas) ====== */
function renderChart(range){
  const canvas = qs("#opsChart"); const ctx = canvas.getContext("2d");
  const width = canvas.width = canvas.clientWidth * devicePixelRatio;
  const height = canvas.height = 260 * devicePixelRatio;
  ctx.clearRect(0,0,width,height);

  // Aggregate by day
  const map = new Map();
  OPS.forEach(d=>{
    if(d.date >= range.from && d.date <= range.to){
      const v = d.entries.reduce((a,b)=>a+b.moved,0);
      map.set(d.date, (map.get(d.date)||0)+v);
    }
  });
  const entries = Array.from(map.entries()).sort((a,b)=>a[0]<b[0]? -1:1);
  if(entries.length===0) return;
  const vals = entries.map(e=>e[1]);
  const dates = entries.map(e=>e[0]);
  const maxV = Math.max(...vals)*1.1;

  // axes
  const m = {l:48, r:12, t:14, b:28};
  ctx.strokeStyle = "rgba(147, 179, 217, .35)";
  ctx.lineWidth = 1;
  for(let i=0;i<4;i++){
    const y = m.t + (height - m.t - m.b) * i/3;
    ctx.beginPath(); ctx.moveTo(m.l, y); ctx.lineTo(width-m.r, y); ctx.stroke();
  }
  // y labels
  ctx.fillStyle="#cfe1ff"; ctx.font = `${12*devicePixelRatio}px system-ui, -apple-system, Segoe UI`;
  ctx.textAlign="right";
  for(let i=0;i<=3;i++){
    const val = Math.round(maxV * (1 - i/3));
    const y = m.t + (height - m.t - m.b) * i/3 + 4*devicePixelRatio;
    ctx.fillText(val.toLocaleString(), m.l - 8*devicePixelRatio, y);
  }

  // line
  ctx.beginPath();
  dates.forEach((d,i)=>{
    const x = m.l + (width - m.l - m.r) * (i/(dates.length-1));
    const y = m.t + (height - m.t - m.b) * (1 - (vals[i]/maxV));
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.lineWidth = 2*devicePixelRatio;
  ctx.strokeStyle = "rgba(110,227,255,.9)";
  ctx.stroke();

  // x labels (sparse)
  ctx.fillStyle="#9fb2cc"; ctx.textAlign="center";
  const step = Math.max(1, Math.floor(dates.length/6));
  for(let i=0;i<dates.length;i+=step){
    const x = m.l + (width - m.l - m.r) * (i/(dates.length-1));
    ctx.fillText(dates[i].slice(5), x, height - 8*devicePixelRatio);
  }
}

/* ====== FILTER ACTIONS ====== */
function currentRange(){
  return { from: qs("#fromDate").value, to: qs("#toDate").value };
}
function applyRange(){
  const r = currentRange();
  renderKV(r); renderOpsTable(r); renderChart(r);
}
qs("#btnApply").addEventListener("click", applyRange);
qs("#btnLastStorm").addEventListener("click", ()=>{
  // pick a recent 3-day window with higher ops (synthetic heuristic)
  let bestDay = OPS.slice(-30).reduce((best, d)=>{
    const moved = d.entries.reduce((a,b)=>a+b.moved,0);
    return moved > best.moved ? {date:d.date, moved} : best;
  }, {date:OPS[OPS.length-10].date, moved:0}).date;
  const b = new Date(bestDay); const a = new Date(b - 2*MS_PER_DAY);
  qs("#fromDate").value = a.toISOString().slice(0,10);
  qs("#toDate").value = b.toISOString().slice(0,10);
  applyRange();
});

/* ====== AI AGENTS TABLE ====== */
function renderAgents(){
  const el = qs("#agentsTable"); el.innerHTML = "";
  const agents = [
    {name:"Autonomy Planner", status:"Connected", conf:0.93, act:"Assigned haul routes"},
    {name:"Excavation Controller", status:"Connected", conf:0.90, act:"Adjusted dig depth (Zone C)"},
    {name:"Fleet Orchestrator", status:"Connected", conf:0.95, act:"Balanced cycle times"},
    {name:"Safety Sentinel", status:"Connected", conf:0.99, act:"No conflicts detected"},
    {name:"Weather Watch", status:"Watch", conf:0.78, act:"Updraft flag – Hajar"}
  ];
  agents.forEach(a=>{
    const dot = a.status==="Connected" ? "ok" : (a.status==="Watch"?"warn":"bad");
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${a.name}</td>
                    <td><span class="status-dot ${dot}"></span> <span style="margin-left:6px">${a.status}</span></td>
                    <td>${a.act}</td>
                    <td>${(a.conf*100).toFixed(0)}%</td>`;
    el.appendChild(tr);
  });
}

/* ====== WEATHER SNAPSHOT (DEMO FIELDS) ====== */
function renderWeather(){
  const el = qs("#wxPanel");
  // synthetic POWER-like fields
  const t = 41 + Math.round(rng()*3); // °C
  const rh = 22 + Math.round(rng()*10);
  const wspd10 = (10 + rng()*12).toFixed(1);
  const dir = Math.round(60 + rng()*40); // deg
  const cape = Math.round(900 + rng()*400);
  el.innerHTML = `
    <div class="kv" style="grid-template-columns:repeat(2,1fr)">
      <div class="tile"><div class="k">Temp (2m)</div><div class="v">${t} °C</div></div>
      <div class="tile"><div class="k">RH (2m)</div><div class="v">${rh}%</div></div>
      <div class="tile"><div class="k">Wind 10m</div><div class="v">${wspd10} m/s</div></div>
      <div class="tile"><div class="k">Direction</div><div class="v">${dir}°</div></div>
      <div class="tile"><div class="k">CAPE (proxy)</div><div class="v">${cape} J/kg</div></div>
      <div class="tile"><div class="k">Cloud Base (est)</div><div class="v">${Math.round(1800 + rng()*600)} m</div></div>
    </div>
    <div class="note" style="margin-top:10px">Demo snapshot. For planning, wire NASA POWER/MERRA-2. For verification, add GPM IMERG.</div>
  `;
}

/* ====== LOGS ====== */
function renderLogs(){
  const el = qs("#logTable"); el.innerHTML = "";
  const now = new Date();
  const events = [
    "Fleet Orchestrator balanced WL02 ↔ DT03 cycles",
    "Planner advanced cut plan for Lake Cell B-3",
    "Safety Sentinel cleared blasting window",
    "Weather Watch marked convective watch (Hajar)",
    "Crusher JC01 throughput at 215 t/h (avg)"
  ];
  for(let i=0;i<12;i++){
    const t = new Date(now - i*60*60*1000);
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td><td>${events[i%events.length]}</td>`;
    el.appendChild(tr);
  }
}

/* ====== RADAR DEMO FAILOVER ====== */
(function initRadar(){
  const video = qs("#radarVid"); const img = qs("#radarImg");
  video?.addEventListener("error", ()=>{ if(img){ img.style.display="block"; } if(video){ video.style.display="none"; }}, {once:true});
})();

/* ====== INIT ====== */
function init(){
  const today = new Date().toISOString().slice(0,10);
  const from = new Date(Date.now()-29*MS_PER_DAY).toISOString().slice(0,10);
  qs("#fromDate").value = from; qs("#toDate").value = today;
  renderAgents(); renderWeather(); applyRange(); renderLogs();
}
init();
</script>
</body>
</html>

